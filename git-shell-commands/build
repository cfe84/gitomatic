#!/bin/bash

# Main dispatcher for build commands
# Usage: build logs <subcommand> [--repo|-r <path>]

source "$HOME/.env"

if [ -z "$EVENTS_DIR" ]; then
  echo "Error: EVENTS_DIR must be set" >&2
  exit 1
fi

# Parse arguments
SUBCOMMAND=""
REPO=""
ARGS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    logs|env|run)
      SUBCOMMAND="$1"
      shift
      ;;
    --repo|-r)
      REPO="$2"
      shift 2
      ;;
    *)
      ARGS+=("$1")
      shift
      ;;
  esac
done

if [ "$SUBCOMMAND" != "logs" ] && [ "$SUBCOMMAND" != "env" ] && [ "$SUBCOMMAND" != "run" ]; then
  echo "Error: Unknown subcommand. Usage: build <logs|env|run> <subcommand> [--repo|-r <path>]" >&2
  exit 1
fi

if [ -z "$REPO" ]; then
  echo "Error: missing repository path. Use --repo|-r to specify it." >&2
  exit 1
fi

RESOLVED_REPO=$(realpath "$REPO_ROOT/$REPO" 2>/dev/null)
if [ $? -ne 0 ] || [ ! -d "$RESOLVED_REPO" ]; then
    echo "Error: Repository path does not exist: $REPO" >&2
    exit 1
fi

if [ -n "$REPO_ROOT" ]; then
    RESOLVED_ROOT=$(realpath "$REPO_ROOT" 2>/dev/null)
    if [ $? -ne 0 ]; then
    echo "Error: REPO_ROOT does not exist: $REPO_ROOT" >&2
    exit 1
    fi

    # Check that RESOLVED_REPO is within REPO_ROOT to prevent directory traversal.
    case "$RESOLVED_REPO" in
    "$RESOLVED_ROOT"/*)
        # Path is within REPO_ROOT
        ;;
    "$RESOLVED_ROOT")
        # Path is exactly REPO_ROOT
        ;;
    *)
        echo "Error: Repository path is outside REPO_ROOT: $RESOLVED_REPO" >&2
        exit 1
        ;;
    esac
fi

SCRIPT_DIR=$(dirname "$(realpath "$0")")

if [ "$SUBCOMMAND" = "logs" ]; then
  exec "$SCRIPT_DIR/build-logs" "$RESOLVED_REPO" "${ARGS[@]}"
elif [ "$SUBCOMMAND" = "env" ]; then
  exec "$SCRIPT_DIR/build-env" "$RESOLVED_REPO" "${ARGS[@]}"
elif [ "$SUBCOMMAND" = "run" ]; then
  exec "$SCRIPT_DIR/build-run" "$RESOLVED_REPO" "${ARGS[@]}"
fi
