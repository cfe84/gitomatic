#!/bin/bash

source "$HOME/.env"

# Git build client dispatcher
# Usage: git-build logs <subcommand> [--repo|-r <path>] [args...]

# Parse arguments
SUBCOMMAND=""
REPO=""
ARGS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    logs|env)
      SUBCOMMAND="$1"
      shift
      ;;
    --repo|-r)
      REPO="$2"
      ARGS+=("--repo" "$2")
      shift 2
      ;;
    *)
      ARGS+=("$1")
      shift
      ;;
  esac
done

# Validate subcommand
if [ "$SUBCOMMAND" != "logs" ] && [ "$SUBCOMMAND" != "env" ]; then
  echo "Error: Unknown subcommand. Usage: git-build <logs|env> <subcommand> [--repo|-r <path>]" >&2
  exit 1
fi

# Determine repository if not specified
if [ -z "$REPO" ]; then
  GIT_REMOTE=$(git remote get-url origin 2>/dev/null)
  if [ $? -ne 0 ]; then
    echo "Error: Unable to determine git repository. Please specify with --repo|-r." >&2
    exit 1
  fi
  IFS=':' read -r _ REPO <<< "$GIT_REMOTE"
  ARGS+=("--repo" "$REPO")
fi

# Get the directory of this script
SCRIPT_DIR=$(dirname "$(realpath "$0")")

# Invoke the appropriate handler
if [ "$SUBCOMMAND" = "logs" ]; then
  exec "$SCRIPT_DIR/git-build-logs" "${ARGS[@]}"
elif [ "$SUBCOMMAND" = "env" ]; then
  exec "$SCRIPT_DIR/git-build-env" "${ARGS[@]}"
fi
